rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* =========================================================================
       1. HELPER FUNCTIONS
       ========================================================================= */
    
    // Check if user is logged in
    function isAuthenticated() {
      return request.auth != null;
    }

    // Fetch the current user's document
    function userDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function userData() {
      return userDoc().data;
    }

    // Check if user exists in DB and is active
    function hasUserDoc() {
      return isAuthenticated() && exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    // PRIMARY ADMIN CHECK
    function isAdmin() {
      return hasUserDoc()
        && userData().active == true
        && (userData().role in ['super_admin', 'content_admin', 'finance_admin']);
    }

    // ROLE SPECIFIC CHECKS
    function isSuperAdmin() {
      return isAdmin() && userData().role == 'super_admin';
    }

    function isFinanceAdmin() {
      return isAdmin() && (userData().role == 'finance_admin' || userData().role == 'super_admin');
    }

    function isContentAdmin() {
      return isAdmin() && (userData().role == 'content_admin' || userData().role == 'super_admin');
    }

    // Hardcoded protection for the main super admin email to prevent accidental lockout
    function protectedEmail() {
      return 'realdahirusalihu@gmail.com';
    }

    /* =========================================================================
       2. USERS & AUTHENTICATION
       ========================================================================= */

    match /users/{userId} {
      // RULE: User can read their own doc (for AuthContext). Admins can read all.
      allow read: if (isAuthenticated() && request.auth.uid == userId) || isAdmin();
      
      // RULE: Only Super Admin can create new admins
      allow create: if isSuperAdmin();

      // RULE: Updates
      // 1. Super Admin can update anyone (but cannot demote the main protected email)
      // 2. Users can update their own basic info (displayName, photoURL) but NOT role/email
      allow update: if 
        (isSuperAdmin() 
          && (resource.data.email != protectedEmail() || request.resource.data.role == 'super_admin')
        ) 
        || 
        (isAuthenticated() && request.auth.uid == userId 
          && request.resource.data.role == resource.data.role
          && request.resource.data.email == resource.data.email
          && request.resource.data.active == resource.data.active
        );

      allow delete: if false; // Never delete users, only deactivate
    }

    /* =========================================================================
       3. PUBLIC CONTENT (Read: Public | Write: Content Admin)
       ========================================================================= */

    // Blogs & Updates
    match /articles/{docId} { allow read: if true; allow write: if isContentAdmin(); }
    match /news/{docId} { allow read: if true; allow write: if isContentAdmin(); }
    match /research/{docId} { allow read: if true; allow write: if isContentAdmin(); }

    // Media Resources
    match /videos/{docId} { allow read: if true; allow write: if isContentAdmin(); }
    match /video_playlists/{docId} { allow read: if true; allow write: if isContentAdmin(); }
    
    match /audios/{docId} { allow read: if true; allow write: if isContentAdmin(); }
    match /audio_series/{docId} { allow read: if true; allow write: if isContentAdmin(); }
    
    match /podcasts/{docId} { allow read: if true; allow write: if isContentAdmin(); }
    match /podcast_shows/{docId} { allow read: if true; allow write: if isContentAdmin(); }
    
    match /ebooks/{docId} { allow read: if true; allow write: if isContentAdmin(); }
    match /ebook_collections/{docId} { allow read: if true; allow write: if isContentAdmin(); }

    // Gallery
    match /gallery_albums/{docId} { allow read: if true; allow write: if isContentAdmin(); }
    match /gallery_photos/{docId} { allow read: if true; allow write: if isContentAdmin(); }

    // Programs & Impact
    match /programs/{docId} { allow read: if true; allow write: if isContentAdmin(); }
    
    // About Us / Team
    match /team_members/{docId} { allow read: if true; allow write: if isContentAdmin(); }
    match /leadership_team/{docId} { allow read: if true; allow write: if isContentAdmin(); }
    match /partners/{docId} { allow read: if true; allow write: if isContentAdmin(); }

    /* =========================================================================
       4. PUBLIC SUBMISSIONS (Create: Public | Read/Write: Admin)
       ========================================================================= */

    // Volunteers (Public Form)
    match /volunteers/{docId} {
      allow create: if true;
      allow read: if isAdmin();
      allow update, delete: if isContentAdmin();
    }

    /* =========================================================================
       5. DONATIONS & FINANCE
       ========================================================================= */

    // Funds (Campaigns)
    match /donation_funds/{docId} {
      allow read: if true; // Public needs to see campaigns
      allow write: if isFinanceAdmin();
    }

    // Donations (Transactions)
    match /donations/{docId} {
      // Public can initiate a donation record
      allow create: if true
        && request.resource.data.amount is number
        && request.resource.data.amount >= 100; // Minimum amount check
      
      // Only admins can view transaction history
      allow read: if isAdmin();
      
      // Only Finance/Super can update status (verify) or delete
      allow update, delete: if isFinanceAdmin();
    }

    /* =========================================================================
       6. SYSTEM SETTINGS
       ========================================================================= */

    // General Settings (Public Read Required for Footer/Header/Home)
    // This includes 'contact_info', 'homepage_hero', 'site_metadata'
    match /general_settings/{docId} {
      allow read: if true;
      allow write: if isSuperAdmin(); // Strict: Only Super Admin changes site config
    }

    // Internal Settings (Private)
    match /settings/{docId} {
      allow read: if isAdmin();
      allow write: if isSuperAdmin();
    }

    // Audit Logs (Immutable)
    match /audit_logs/{docId} {
      allow read: if isAdmin();
      allow create: if isAdmin(); // System writes logs via Admin SDK or Client Admin
      allow update, delete: if false; // Audit logs are permanent
    }

    /* =========================================================================
       7. CATCH-ALL (Safety Net)
       ========================================================================= */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
