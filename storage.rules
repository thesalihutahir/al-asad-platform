rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    /* =========================================================================
       1. HELPER FUNCTIONS
       ========================================================================= */
    
    function isAuthenticated() {
      return request.auth != null;
    }

    // We verify admin status via Firestore lookup
    // Note: This requires the Firestore rules to allow the lookup
    function isAdmin() {
      return isAuthenticated() 
        && firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.active == true
        && firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'content_admin', 'finance_admin'];
    }

    function isImage() {
      return request.resource.contentType.matches('image/.*');
    }

    function isPdf() {
      return request.resource.contentType == 'application/pdf';
    }

    function isAudio() {
      return request.resource.contentType.matches('audio/.*');
    }

    function smallEnough(maxMB) {
      return request.resource.size < maxMB * 1024 * 1024;
    }

    /* =========================================================================
       2. PUBLIC READ PATHS
       ========================================================================= */

    // Blog & Article Images
    match /blog_images/{allPaths=**} {
      allow read: if true;
      allow write: if isAdmin() && isImage() && smallEnough(10);
    }
    
    match /article_covers/{allPaths=**} {
      allow read: if true;
      allow write: if isAdmin() && isImage() && smallEnough(10);
    }

    // Team & Leadership
    match /team/{allPaths=**} {
      allow read: if true;
      allow write: if isAdmin() && isImage() && smallEnough(5);
    }

    // Gallery
    match /gallery/{allPaths=**} {
      allow read: if true;
      allow write: if isAdmin() && isImage() && smallEnough(15);
    }

    // Program Images
    match /programs/{allPaths=**} {
      allow read: if true;
      allow write: if isAdmin() && isImage() && smallEnough(10);
    }

    // eBooks (Covers and PDFs)
    match /ebooks/{allPaths=**} {
      allow read: if true;
      allow write: if isAdmin() && (isPdf() || isImage()) && smallEnough(100);
    }

    // Research Papers (PDFs)
    match /research_pdfs/{allPaths=**} {
      allow read: if true;
      allow write: if isAdmin() && isPdf() && smallEnough(50);
    }
    
    // Audio Files (Wait, usually externally hosted, but if stored here:)
    match /audio_files/{allPaths=**} {
      allow read: if true;
      allow write: if isAdmin() && isAudio() && smallEnough(100);
    }
    
    // Video Thumbnails
    match /video_thumbnails/{allPaths=**} {
      allow read: if true;
      allow write: if isAdmin() && isImage() && smallEnough(5);
    }

    /* =========================================================================
       3. RESTRICTED PATHS
       ========================================================================= */

    // Donation Receipts (Private)
    match /donation_receipts/{allPaths=**} {
      allow read: if isAdmin();
      allow write: if isAdmin() || (true); // Public upload during donation flow if implemented
    }

    // Admin Avatars
    match /avatars/{userId}/{allPaths=**} {
      allow read: if true;
      allow write: if isAuthenticated() && request.auth.uid == userId && isImage() && smallEnough(2);
    }

    /* =========================================================================
       4. DEFAULT
       ========================================================================= */
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
